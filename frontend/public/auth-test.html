<!DOCTYPE html>
<html>
<head>
    <title>TSW Fantasy - Quick Auth Test</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>TSW Fantasy - Quick Auth Test</h1>
    <div id="status">Loading...</div>
    
    <div id="signup-form" style="margin: 20px 0;">
        <h3>Test Signup</h3>
        <input type="text" id="username" placeholder="Username" />
        <input type="email" id="email" placeholder="Email" />
        <input type="password" id="password" placeholder="Password" />
        <button onclick="testSignup()">Test Signup</button>
    </div>
    
    <div id="login-form" style="margin: 20px 0;">
        <h3>Test Login</h3>
        <input type="text" id="loginUsername" placeholder="Username" />
        <input type="password" id="loginPassword" placeholder="Password" />
        <button onclick="testLogin()">Test Login</button>
    </div>
    
    <div id="results" style="margin: 20px 0; background: #f5f5f5; padding: 10px;">
        <h3>Results:</h3>
        <pre id="log"></pre>
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBkpza15mv5CswxyrknUX7hIUKmTLuX0D0",
            authDomain: "tsw-fantasy.firebaseapp.com",
            projectId: "tsw-fantasy",
            storageBucket: "tsw-fantasy.appspot.com",
            messagingSenderId: "380158093213",
            appId: "1:380158093213:web:1f2b2651cc601e56faf174"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        function log(message) {
            const logElement = document.getElementById('log');
            logElement.textContent += new Date().toISOString() + ': ' + message + '\n';
            console.log(message);
        }

        async function testSignup() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            log('🚀 Starting signup test...');
            log(`Username: ${username}, Email: ${email}`);
            
            try {
                // Step 1: Check if username exists
                log('📝 Checking username availability...');
                const usernameDoc = await db.collection('users').doc(username.toLowerCase()).get();
                
                if (usernameDoc.exists) {
                    log('❌ Username already exists');
                    return;
                }
                log('✅ Username available');
                
                // Step 2: Create Firebase Auth user
                log('🔐 Creating Firebase Auth user...');
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                log(`✅ Firebase Auth user created: ${user.uid}`);
                
                // Step 3: Update profile
                log('👤 Updating user profile...');
                await user.updateProfile({ displayName: username });
                log('✅ Profile updated');
                
                // Step 4: Create Firestore document
                log('💾 Creating Firestore document...');
                const userData = {
                    uid: user.uid,
                    username: username,
                    email: email,
                    displayName: username,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    budget: 150000000,
                    totalPoints: 0
                };
                
                await db.collection('users').doc(username.toLowerCase()).set(userData);
                log('✅ Firestore document created successfully!');
                log('🎉 SIGNUP COMPLETE!');
                
            } catch (error) {
                log(`❌ Signup error: ${error.code} - ${error.message}`);
                console.error('Full error:', error);
            }
        }
        
        async function testLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            log('🚀 Starting login test...');
            log(`Username: ${username}`);
            
            try {
                // Step 1: Get user document to find email
                log('🔍 Looking up user document...');
                const userDoc = await db.collection('users').doc(username.toLowerCase()).get();
                
                if (!userDoc.exists) {
                    log('❌ Username not found in database');
                    return;
                }
                
                const userData = userDoc.data();
                const email = userData.email;
                log(`✅ User found, email: ${email}`);
                
                // Step 2: Login with Firebase Auth
                log('🔐 Attempting Firebase Auth login...');
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                log(`✅ Login successful: ${userCredential.user.uid}`);
                log('🎉 LOGIN COMPLETE!');
                
            } catch (error) {
                log(`❌ Login error: ${error.code} - ${error.message}`);
                console.error('Full error:', error);
            }
        }

        // Auth state listener
        auth.onAuthStateChanged((user) => {
            const status = document.getElementById('status');
            if (user) {
                status.innerHTML = `✅ Logged in as: ${user.email} (${user.displayName || 'No display name'})`;
                log(`🔄 Auth state: Logged in as ${user.email}`);
            } else {
                status.innerHTML = '❌ Not logged in';
                log('🔄 Auth state: Not logged in');
            }
        });

        log('🎯 Auth test page loaded and ready!');
    </script>
</body>
</html>
